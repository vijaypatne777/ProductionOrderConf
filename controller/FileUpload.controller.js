sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessagePopover","sap/m/MessageItem","sap/ui/core/format/DateFormat","sap/m/Button"],function(e,r,t,s,a,i){"use strict";var o;return e.extend("Prod_Ord_Conf.Production_Ord_Conf.controller.FileUpload",{onInit:function(){this._pModel=this.getOwnerComponent().getModel("PORD");this._tModel=new sap.ui.model.json.JSONModel;this._msgModel=new sap.ui.model.json.JSONModel;this._oPromises=[];this._msgArr=[];this._msgData={msgs:this._msgArr};var e=this.byId("cUpload");e.setEnabled(false)},handleUploadPress:function(){function e(e,r){var t=parseInt(r.OrdNo);var s=parseInt(e.OrdNo);var a=parseInt(e.OpNo);var i=parseInt(r.OpNo);if(s<t){return-1}if(t==s){if(a<i)return-1}}var t=this;var s=[];var a=[];var i={prec:a};var o=this.byId("fileUploader");var n=this.byId("prodTable");if(!o.getValue()){r.show("Select the file first!");return}else{var d=o.getFocusDomRef();var c=d.files[0];if(c&&window.FileReader){var u=new FileReader;u.onload=function(r){var o=r.target.result;var d=o.match(/[\w .]+(?=,?)/g);var c=14;var u=d.splice(0,c);while(d.length>0){var l={};var p={};var m=d.splice(0,c);for(var f=0;f<m.length;f++){l[u[f]]=m[f].trim();switch(f){case 0:p["OrdNo"]=l[u[f]];break;case 1:p["OpNo"]=l[u[f]];break;case 2:p["Seq"]=l[u[f]];break;case 3:p["Ctype"]=l[u[f]];break;case 4:p["Quan"]=l[u[f]];break;case 5:p["Unit"]=l[u[f]];break;case 6:p["CTEXT"]=l[u[f]];break;case 7:var h=l[u[f]];p["ValidF"]=h.substr(0,4)+"-"+h.substr(4,2)+"-"+h.substr(6,2)+"T00:00:00";break;case 8:var g=l[u[f]];p["ValidFT"]="PT"+g.substr(0,2)+"H"+g.substr(2,2)+"M"+g.substr(4,2)+"S";break;case 9:var b=l[u[f]];p["ValidFE"]=b.substr(0,4)+"-"+b.substr(4,2)+"-"+b.substr(6,2)+"T00:00:00";break;case 10:var v=l[u[f]];p["ValidFET"]="PT"+v.substr(0,2)+"H"+v.substr(2,2)+"M"+v.substr(4,2)+"S";break;case 11:var C=l[u[f]];p["PDATE"]=C.substr(0,4)+"-"+C.substr(4,2)+"-"+C.substr(6,2)+"T00:00:00";break;case 12:p["BT"]=l[u[f]];break;case 13:p["PNO"]=l[u[f]];break}}s.push(l);a.push(p)}a.sort(e);t._tModel.setData(i);n.setModel(t._tModel);var M=t.byId("cUpload");M.setEnabled(true);t.byId("fileUploader").setEnabled(false);t.byId("tUpload").setEnabled(false)};u.readAsBinaryString(c)}}},createProdConfPress:function(){function e(e,r){var t=(e.getTime()-r.getTime())/1e3;var s=t/(60*60);return Math.abs(Math.round(s))}sap.ui.core.BusyIndicator.show();var r=this;var t=this._tModel.getData();var s=this._pModel;var a;for(var i=0;i<t.prec.length;i++){var o={};o.OrderID=t.prec[i].OrdNo;o.OrderOperation=t.prec[i].OpNo;o.Sequence=t.prec[i].Seq;if(t.prec[i].Ctype=="Y"){o.FinalConfirmationType="X"}o.ConfirmationYieldQuantity=t.prec[i].Quan;o.ConfirmationUnit=t.prec[i].Unit;o.ConfirmedExecutionStartDate=t.prec[i].ValidF;o.ConfirmedExecutionStartTime=t.prec[i].ValidFT;o.ConfirmedProcessingEndDate=t.prec[i].ValidFE;o.ConfirmedProcessingEndTime=t.prec[i].ValidFET;var n=o.ConfirmedExecutionStartDate;var d=o.ConfirmedProcessingEndDate;var c=o.ConfirmedExecutionStartTime;var u=o.ConfirmedProcessingEndTime;var l=n.substr(0,4)+"/"+n.substr(5,2)+"/"+n.substr(8,2)+" "+c.substr(2,2)+":"+c.substr(5,2)+":"+c.substr(8,2);var p=d.substr(0,4)+"/"+d.substr(5,2)+"/"+d.substr(8,2)+" "+u.substr(2,2)+":"+u.substr(5,2)+":"+u.substr(8,2);var m=new Date(l);var f=new Date(p);var h=e(f,m);o.ConfirmationText="Production Hours="+h+"HR"+" "+t.prec[i].CTEXT;o.PostingDate=t.prec[i].Pdate;o.ConfirmedBreakDuration=t.prec[i].BT;o.Personnel=t.prec[i].PNO;a="GID"+i;var g=new Promise(function(e,t){s.create("/ProdnOrdConf2",o,{success:function(t){var s={};s["Mtype"]="Success";s["Msg"]="Production Order Confirmattion created with Confirmation Group "+t.ConfirmationGroup+t.ConfirmationCount;r._msgArr.push(s);e()},error:function(e){var s={};s["Mtype"]="Error";s["Msg"]=e.responseText;r._msgArr.push(s);t()},groupId:a})});this._oPromises.push(g)}return this._oPromises},promiseCompleted:function(){this._msgData.msgs=this._msgArr;this._msgModel.setData(this._msgData);sap.ui.getCore().setModel(this._msgModel,"mModel");var e=new s({type:"{type}",title:"{title}",activeTitle:"{active}",description:"{description}",subtitle:"{subtitle}",counter:"{counter}"});o=new t({items:{path:"/",template:e},activeTitlePress:function(){}});var r=0;var a=0;var n=[];for(var d=0;d<this._msgArr.length;d++){var c={};if(this._msgArr[d].Mtype=="Success"){c["type"]=this._msgArr[d].Mtype;c["title"]="Success Message";c["active"]=false;c["description"]=this._msgArr[d].Msg;c["subtitle"]="Production Order Confirmaiton Created";r=r+1;c["conunter"]=r}else{c["type"]=this._msgArr[d].Mtype;c["title"]="Error Message";c["active"]=true;c["description"]=this._msgArr[d].Msg;c["subtitle"]="Production Order Confirmaiton Creattion Failed";a=a+1;c["conunter"]=r}n.push(c)}var u=new sap.ui.model.json.JSONModel;u.setData(n);this.getView().setModel(u);var l=new i({id:"logBut",text:"Log",formter:function(){}});l.addStyleClass("sapUiMediumMarginTop");l.addDependent(o);l.attachPress(this.handleMessagePopoverPress);var p=this.getView().byId("oToolBar");p.addContent(l);this.byId("cUpload").setEnabled(false);this.byId("tUpload").setEnabled(false);this.byId("fileUploader").setEnabled(false)},handlePost:function(){var e=this;var t=0;Promise.allSettled=function(s){s.forEach(function(s){s.then(function(a){t=t+1;if(t===e._oPromises.length){sap.ui.core.BusyIndicator.hide();r.show(t+"Production Order Confirmation successfully Created");e.promiseCompleted()}return s},function(r){t=t+1;if(t===e._oPromises.length){sap.ui.core.BusyIndicator.hide();e.promiseCompleted()}})});return s};var s=[];s=this.createProdConfPress();var a=Promise.allSettled(s)},buttonTypeFormatter:function(){var e;var r=this.getView().getModel().oData;r.forEach(function(r){switch(r.type){case"Error":e="Negative";break;case"Warning":e=e!=="Negative"?"Critical":e;break;case"Success":e=e!=="Negative"&&e!=="Critical"?"Success":e;break;default:e=!e?"Neutral":e;break}});return e},buttonIconFormatter:function(){var e;var r=this.getView().getModel().oData;r.forEach(function(r){switch(r.type){case"Error":e="sap-icon://message-error";break;case"Warning":e=e!=="sap-icon://message-error"?"sap-icon://message-warning":e;break;case"Success":e="sap-icon://message-error"&&e!=="sap-icon://message-warning"?"sap-icon://message-success":e;break;default:e=!e?"sap-icon://message-information":e;break}});return e},handleMessagePopoverPress:function(e){o.toggle(e.getSource())},handleRefresh:function(){this._tModel.setData();this._msgArr=[];this._oPromises=[];this._msgModel.setData();this.byId("tUpload").setEnabled(true);this.byId("fileUploader").setEnabled(true);this.byId("fileUploader").clear();this.byId("cUpload").setEnabled(false);var e=sap.ui.getCore().byId("logBut");e.destroy()}})});