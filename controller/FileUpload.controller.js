sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessagePopover","sap/m/MessageItem","sap/ui/core/format/DateFormat","sap/m/Button"],function(e,r,t,s,a,o){"use strict";var i;return e.extend("Prod_Ord_Conf.Production_Ord_Conf.controller.FileUpload",{onInit:function(){this._pModel=this.getOwnerComponent().getModel("PORD");this._tModel=new sap.ui.model.json.JSONModel;this._msgModel=new sap.ui.model.json.JSONModel;this._oPromises=[];this._msgArr=[];this._msgData={msgs:this._msgArr};var e=this.byId("cUpload");e.setEnabled(false)},handleUploadPress:function(){function e(e,r){var t=parseInt(r.OrdNo);var s=parseInt(e.OrdNo);var a=parseInt(e.OpNo);var o=parseInt(r.OpNo);if(s<t){return-1}if(t==s){if(a<o)return-1}}var t=this;var s=[];var a=[];var o={prec:a};var i=this.byId("fileUploader");var n=this.byId("prodTable");if(!i.getValue()){r.show("Select the file first!");return}else{var d=i.getFocusDomRef();var u=d.files[0];if(u&&window.FileReader){var c=new FileReader;c.onload=function(r){var i=r.target.result;var d=i.replace(/\n/g,",").split(",");var u=11;var c=d.splice(0,u);while(d.length-1>0){var l={};var p={};var v=d.splice(0,u);for(var b=0;b<v.length;b++){l[c[b]]=v[b].trim();switch(b){case 0:p["OrdNo"]=l[c[b]];break;case 1:p["OpNo"]=l[c[b]];break;case 2:p["Quan"]=l[c[b]];break;case 3:p["CTEXT"]=l[c[b]];break;case 4:var g=l[c[b]];p["ValidF"]=g.substr(0,4)+"-"+g.substr(4,2)+"-"+g.substr(6,2)+"T00:00:00";break;case 5:var h=l[c[b]];p["ValidFT"]="PT"+h.substr(0,2)+"H"+h.substr(2,2)+"M"+h.substr(4,2)+"S";break;case 6:var f=l[c[b]];p["ValidFE"]=f.substr(0,4)+"-"+f.substr(4,2)+"-"+f.substr(6,2)+"T00:00:00";break;case 7:var m=l[c[b]];p["ValidFET"]="PT"+m.substr(0,2)+"H"+m.substr(2,2)+"M"+m.substr(4,2)+"S";break;case 8:var E=l[c[b]];p["PDATE"]=E.substr(0,4)+"-"+E.substr(4,2)+"-"+E.substr(6,2)+"T00:00:00";break;case 9:p["BT"]=l[c[b]];break;case 10:p["PNO"]=l[c[b]];break}}s.push(l);a.push(p)}a.sort(e);t._tModel.setData(o);n.setModel(t._tModel);var C=t.validateFileData();if(C){var M=t.byId("cUpload");M.setEnabled(true);t.byId("fileUploader").setEnabled(false);t.byId("tUpload").setEnabled(false)}};c.readAsBinaryString(u)}}},createProdConfPress:function(){function e(e,r){var t=(e.getTime()-r.getTime())/1e3;var s=t/(60*60);return Number(Math.round(s+"e2")+"e-2").toFixed(2)}sap.ui.core.BusyIndicator.show();var r=this;var t=this._tModel.getData();var s=this._pModel;var a;var o;var i;for(var n=0;n<t.prec.length;n++){var d={};d.OrderID=t.prec[n].OrdNo;d.OrderOperation=t.prec[n].OpNo;d.Sequence="0";d.ConfirmationYieldQuantity=t.prec[n].Quan;d.ConfirmedExecutionStartDate=t.prec[n].ValidF;d.ConfirmedExecutionStartTime=t.prec[n].ValidFT;d.ConfirmedProcessingEndDate=t.prec[n].ValidFE;d.ConfirmedProcessingEndTime=t.prec[n].ValidFET;var u=d.ConfirmedExecutionStartDate;var c=d.ConfirmedProcessingEndDate;var l=d.ConfirmedExecutionStartTime;var p=d.ConfirmedProcessingEndTime;var v=u.substr(0,4)+"/"+u.substr(5,2)+"/"+u.substr(8,2)+" "+l.substr(2,2)+":"+l.substr(5,2)+":"+l.substr(8,2);var b=c.substr(0,4)+"/"+c.substr(5,2)+"/"+c.substr(8,2)+" "+p.substr(2,2)+":"+p.substr(5,2)+":"+p.substr(8,2);var g=new Date(v);var h=new Date(b);var f=e(h,g);var m=f.split(".");var E=m[0];var C;if(E.toString().length==1){C="00"+f}if(E.toString().length==2){C="0"+f}if(E.toString().length==3){C=f}d.OpConfirmedWorkQuantity1=f;d.OpWorkQuantityUnit1="HR";d.ConfirmationText="Production Hours="+C+"HR"+" "+t.prec[n].CTEXT;d.PostingDate=t.prec[n].PDATE;d.ConfirmedBreakDuration=t.prec[n].BT;d.BreakDurationUnit="MIN";d.Personnel=t.prec[n].PNO;if(n==0){i=0;a="GID"+i;o=d.OrderID}if(o!==d.OrderID){i=i+1;o=d.OrderID;a="GID"+i}var M=new Promise(function(e,t){s.create("/ProdnOrdConf2",d,{success:function(t){var s={};s["Mtype"]="Success";s["Msg"]="Production Order Confirmattion created with Confirmation Group "+t.ConfirmationGroup+t.ConfirmationCount;r._msgArr.push(s);e()},error:function(e){var s={};s["Mtype"]="Error";s["Msg"]=e.responseText;r._msgArr.push(s);t()},groupId:a})});this._oPromises.push(M)}return this._oPromises},promiseCompleted:function(){this._msgData.msgs=this._msgArr;this._msgModel.setData(this._msgData);sap.ui.getCore().setModel(this._msgModel,"mModel");var e=new s({type:"{type}",title:"{title}",activeTitle:"{active}",description:"{description}",subtitle:"{subtitle}",counter:"{counter}"});i=new t({items:{path:"/",template:e},activeTitlePress:function(){}});var r=0;var a=0;var n=[];for(var d=0;d<this._msgArr.length;d++){var u={};if(this._msgArr[d].Mtype=="Success"){u["type"]=this._msgArr[d].Mtype;u["title"]="Success Message";u["active"]=false;u["description"]=this._msgArr[d].Msg;u["subtitle"]="Production Order Confirmaiton Created";r=r+1;u["conunter"]=r}else{u["type"]=this._msgArr[d].Mtype;u["title"]="Error Message";u["active"]=true;u["description"]=this._msgArr[d].Msg;u["subtitle"]="Production Order Confirmaiton Creattion Failed";a=a+1;u["conunter"]=r}n.push(u)}var c=new sap.ui.model.json.JSONModel;c.setData(n);this.getView().setModel(c);var l=new o({id:"logBut",text:"Log",type:"Emphasized",width:"6rem",formter:function(){}});l.addDependent(i);l.attachPress(this.handleMessagePopoverPress);var p=this.getView().byId("oToolBar");p.addContent(l);this.byId("cUpload").setEnabled(false);this.byId("tUpload").setEnabled(false);this.byId("fileUploader").setEnabled(false)},handlePost:function(){var e=this;var r=0;Promise.allSettled=function(t){t.forEach(function(t){t.then(function(s){r=r+1;if(r===e._oPromises.length){sap.ui.core.BusyIndicator.hide();e.promiseCompleted()}return t},function(t){r=r+1;if(r===e._oPromises.length){sap.ui.core.BusyIndicator.hide();e.promiseCompleted()}})});return t};var t=[];t=this.createProdConfPress();var s=Promise.allSettled(t)},buttonTypeFormatter:function(){var e;var r=this.getView().getModel().oData;r.forEach(function(r){switch(r.type){case"Error":e="Negative";break;case"Warning":e=e!=="Negative"?"Critical":e;break;case"Success":e=e!=="Negative"&&e!=="Critical"?"Success":e;break;default:e=!e?"Neutral":e;break}});return e},buttonIconFormatter:function(){var e;var r=this.getView().getModel().oData;r.forEach(function(r){switch(r.type){case"Error":e="sap-icon://message-error";break;case"Warning":e=e!=="sap-icon://message-error"?"sap-icon://message-warning":e;break;case"Success":e="sap-icon://message-error"&&e!=="sap-icon://message-warning"?"sap-icon://message-success":e;break;default:e=!e?"sap-icon://message-information":e;break}});return e},handleMessagePopoverPress:function(e){i.toggle(e.getSource())},handleRefresh:function(){this._tModel.setData();this._msgArr=[];this._oPromises=[];this._msgModel.setData();this.byId("tUpload").setEnabled(true);this.byId("fileUploader").setEnabled(true);this.byId("fileUploader").clear();this.byId("cUpload").setEnabled(false);var e=sap.ui.getCore().byId("logBut");e.destroy()},validateFileData:function(){var e=this._tModel.getData();var r=0;var a=[];for(var n=0;n<e.prec.length;n++){var d=e.prec[n].ValidFT;var u=e.prec[n].ValidFET;var c=d.substr(2,2);var l=d.substr(5,2);var p=d.substr(8,2);var v=u.substr(2,2);var b=u.substr(5,2);var g=u.substr(8,2);var h=e.prec[n].ValidF;var f=e.prec[n].ValidFE;var m=e.prec[n].ValidFT;var E=e.prec[n].ValidFET;var C=h.substr(0,4)+"/"+h.substr(5,2)+"/"+h.substr(8,2)+" "+m.substr(2,2)+":"+m.substr(5,2)+":"+m.substr(8,2);var M=f.substr(0,4)+"/"+f.substr(5,2)+"/"+f.substr(8,2)+" "+E.substr(2,2)+":"+E.substr(5,2)+":"+E.substr(8,2);var T=new Date(C);var y=new Date(M);if(T>y){var D={};e.prec[n]["SDColorCode"]="Red";e.prec[n]["EDColorCode"]="Red";D["type"]="Error";D["title"]="Error Message";D["active"]=true;D["description"]="Execution Start Date Time is greator than Execution End Date Time  !";D["subtitle"]="Start Date Time is beyoud End Date Time ! ";r=r+1;D["conunter"]=r;a.push(D)}var P=e.prec[n].BT;if(isNaN(P)){var w={};e.prec[n]["BTColorCode"]="Red";w["type"]="Error";w["title"]="Error Message";w["active"]=true;w["description"]="Break Time should be numeric value!";w["subtitle"]="Break Time is not number ! ";r=r+1;w["conunter"]=r;a.push(w)}else{}if(e.prec[n].BT==""){var _={};e.prec[n]["BTColorCode"]="Red";_["type"]="Error";_["title"]="Error Message";_["active"]=true;_["description"]="Break Time can not be blank !";_["subtitle"]="Break Time is wrong ! ";r=r+1;_["conunter"]=r;a.push(_)}if(c>23){e.prec[n]["FTColorCode"]="Red";var I={};I["type"]="Error";I["title"]="Error Message";I["active"]=true;I["description"]="Hours can not be greator than 23";I["subtitle"]="Hours are wrong ! ";r=r+1;I["conunter"]=r;a.push(I)}if(l>59){e.prec[n]["FTColorCode"]="Red";var S={};S["type"]="Error";S["title"]="Error Message";S["active"]=true;S["description"]="Minutes can not be greator than 59";S["subtitle"]="Minutes are wrong ! ";r=r+1;S["conunter"]=r;a.push(S)}if(p>59){e.prec[n]["FTColorCode"]="Red";var F={};F["type"]="Error";F["title"]="Error Message";F["active"]=true;F["description"]="Seconds can not be greator than 59";F["subtitle"]="Seconds are wrong ! ";r=r+1;F["conunter"]=r;a.push(F)}if(v>23){e.prec[n]["FETColorCode"]="Red";var O={};O["type"]="Error";O["title"]="Error Message";O["active"]=true;O["description"]="Hours can not be greator than 23";O["subtitle"]="Hours are wrong ! ";r=r+1;O["conunter"]=r;a.push(O)}if(b>59){e.prec[n]["FETColorCode"]="Red";var k={};k["type"]="Error";k["title"]="Error Message";k["active"]=true;k["description"]="Minutes can not be greator than 59";k["subtitle"]="Minutes are wrong ! ";r=r+1;k["conunter"]=r;a.push(k)}if(g>59){e.prec[n]["FETColorCode"]="Red";var B={};B["type"]="Error";B["title"]="Error Message";B["active"]=true;B["description"]="Seconds can not be greator than 59";B["subtitle"]="Seconds are wrong ! ";r=r+1;F["conunter"]=r;a.push(B)}}this._tModel.setData(e);var N=new s({type:"{type}",title:"{title}",activeTitle:"{active}",description:"{description}",subtitle:"{subtitle}",counter:"{counter}"});if(a.length>0){i=new t({items:{path:"/",template:N},activeTitlePress:function(){}});var V=new sap.ui.model.json.JSONModel;V.setData(a);this.getView().setModel(V);var U=new o({id:"logBut",text:"Log",type:"Emphasized",width:"6rem",formter:function(){}});U.addDependent(i);U.attachPress(this.handleMessagePopoverPress);var R=this.getView().byId("oToolBar");R.addContent(U);this.byId("cUpload").setEnabled(false);this.byId("tUpload").setEnabled(false);this.byId("fileUploader").setEnabled(false);return false}else{return true}}})});